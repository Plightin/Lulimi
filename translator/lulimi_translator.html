<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lulimi - Public Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.flex {
            display: flex;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center bg-gray-900 text-gray-200 p-4">

    <div class="w-full max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Lulimi Translator</h1>
            <p class="text-lg text-gray-400">Common Zambian Phrases (Powered by the Lulimi CCP)</p>
        </header>

        <main class="bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center mb-6">
                <!-- From Language -->
                <div class="md:col-span-1">
                    <label for="from-lang" class="block text-sm font-medium text-gray-300 mb-2">From</label>
                    <select id="from-lang" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="EN">English</option>
                        <option value="NY">Nyanja (Chichewa)</option>
                        <option value="BM">Bemba (Ichibemba)</option>
                        <option value="TO">Tonga (Chitonga)</option>
                        <option value="LO">Lozi (Silozi)</option>
                    </select>
                </div>

                <!-- Swap Button -->
                <div class="flex justify-center items-end h-full">
                    <button id="swap-btn" class="p-3 bg-gray-700 rounded-full text-gray-300 hover:bg-gray-600 transition duration-150" title="Swap languages">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0l-3 3m3-3l3 3m7 8v12m0 0l-3-3m3 3l3-3" />
                        </svg>
                    </button>
                </div>

                <!-- To Language -->
                <div class="md:col-span-1">
                    <label for="to-lang" class="block text-sm font-medium text-gray-300 mb-2">To</label>
                    <select id="to-lang" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="EN">English</option>
                        <option value="NY" selected>Nyanja (Chichewa)</option>
                        <option value="BM">Bemba (Ichibemba)</option>
                        <option value="TO">Tonga (Chitonga)</option>
                        <option value="LO">Lozi (Silozi)</option>
                    </select>
                </div>
            </div>

            <!-- Text Input -->
            <div class="mb-6">
                <label for="text-input" class="block text-sm font-medium text-gray-300 mb-2">Enter text...</label>
                <textarea id="text-input" rows="5" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., The quick brown fox..."></textarea>
            </div>

            <!-- Translate Button -->
            <button id="translate-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center">
                <svg id="translate-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 1h6m-6 2h6m-6 2h6m-6 2h6M9 21v-2m0 0l-2-2m2 2l2-2m-2-2h6M3 17h6M3 13h6m0 0v6m0-6h6m-6 0h6" />
                </svg>
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="translate-btn-text">Translate</span>
            </button>

            <!-- Translation Output -->
            <div class="mt-6">
                <label for="translation-output" class="block text-sm font-medium text-gray-300 mb-2">Translation</label>
                <textarea id="translation-output" rows="5" class="w-full bg-gray-900 border border-gray-700 text-gray-400 rounded-lg p-3" readonly placeholder="Translation will appear here..."></textarea>
            </div>
        </main>

        <footer class="text-center mt-8 text-gray-500">
             <a href="https://lulimi-ccp-457527257985.africa-south1.run.app" id="contribute-btn" class="mb-6 inline-block bg-gray-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600 transition duration-150">
                Contribute to Lulimi CCP
            </a>
            <p class="text-sm">&copy; 2025 Lulimi Language Engine by Inwit Systems Ltd.</p>
            <p class="text-xs mt-1">Building bridges, one word at a time.</p>
            <div class="flex flex-wrap justify-center gap-x-4 gap-y-2 mt-4 text-xs">
                <a href="https://onelink.to/inwitapp" class="hover:text-indigo-400" target="_blank">Download Inwit App</a>
                <a href="https://inwitsystems.com/radio/" class="hover:text-indigo-400" target="_blank">Inwit Online Radio</a>
                <a href="https://inwitsystems.com/" class="hover:text-indigo-400" target="_blank">More From Inwit Systems</a>
                <a href="https://inwit.tv/" class="hover:text-indigo-400" target="_blank">Stream Inwit TV</a>
            </div>
        </footer>
    </div>

    <!-- Modal -->
    <div id="error-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-semibold text-white mb-4">Error</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Could not connect to translation service.</p>
            <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">
                Close
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        let db, auth;
        let validatedSentencesRef;
        const appId = "default-app-id"; // Use default public app ID

        // This is your *live* configuration for the deployed app on Cloud Run
        const firebaseConfig = {
            apiKey: "AIzaSyBt_tv7FR5FxyDLpYxl8ZhyyZfqeB22e0Q",
            authDomain: "lulimi-ccp-project.firebaseapp.com",
            projectId: "lulimi-ccp-project",
            storageBucket: "lulimi-ccp-project.appspot.com",
            // Note: MessagingSenderId and AppId are not needed for this app
        };
        
        // This is the config for the *secure Canvas environment*
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check if we are in the secure Canvas environment or on the live URL
                const isCanvas = !!canvasFirebaseConfig;
                let activeConfig = isCanvas ? canvasFirebaseConfig : firebaseConfig;

                if (!activeConfig || !activeConfig.projectId) {
                    throw new Error("Firebase config is missing or invalid.");
                }
                
                if (isCanvas) {
                    console.log("Initializing with secure Canvas config.");
                } else {
                    console.log("Initializing with public production config.");
                }

                const app = initializeApp(activeConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Define the public collection path
                const collectionPath = `artifacts/${appId}/public/data/validated_sentences`;
                validatedSentencesRef = collection(db, collectionPath);

                // Authenticate the user
                await signInAnonymously(auth);
                console.log("Anonymous sign-in successful.");

                // Hide modal on init
                hideModal();

            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                showModal("Auth Error", "Could not connect to translation service.");
            }

            // --- Event Listeners ---
            document.getElementById('translate-btn').addEventListener('click', handleTranslate);
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
            document.getElementById('swap-btn').addEventListener('click', swapLanguages);
        });

        // --- Core Translation Logic ---
        async function handleTranslate() {
            setLoading(true);
            const fromLang = document.getElementById('from-lang').value;
            const toLang = document.getElementById('to-lang').value;
            const textToTranslate = document.getElementById('text-input').value.trim();

            // *** FIX: Normalize text to lowercase for case-insensitive search ***
            const normalizedText = textToTranslate.toLowerCase();

            const outputEl = document.getElementById('translation-output');
            
            if (!normalizedText) {
                outputEl.value = "Please enter text to translate.";
                setLoading(false);
                return;
            }

            try {
                const result = await performTranslation(normalizedText, fromLang, toLang);
                outputEl.value = result;
            } catch (error) {
                console.error("Translation error:", error);
                outputEl.value = "Error: Could not perform translation.";
            } finally {
                setLoading(false);
            }
        }

        async function performTranslation(normalizedText, fromLang, toLang) {
            const outputNotFound = "Translation not found. Our database is still growing!";
            const sourceLangField = getLanguageField(fromLang);
            const targetLangField = getLanguageField(toLang);

            // Case 1: Direct Translation (e.g., Nyanja -> English or English -> Nyanja)
            if (fromLang === 'EN' || toLang === 'EN') {
                const q = query(
                    validatedSentencesRef,
                    where(sourceLangField, "==", normalizedText),
                    limit(1)
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    return outputNotFound;
                }
                const docData = querySnapshot.docs[0].data();
                return docData[targetLangField] || outputNotFound;
            }

            // Case 2: Pivot Translation (e.g., Nyanja -> English -> Bemba)
            // Step 1: Source Language to English
            const pivotQ1 = query(
                validatedSentencesRef,
                where(sourceLangField, "==", normalizedText),
                limit(1)
            );
            const pivotSnap1 = await getDocs(pivotQ1);

            if (pivotSnap1.empty) {
                return outputNotFound;
            }
            const pivotResult = pivotSnap1.docs[0].data().english;

            if (!pivotResult) {
                return outputNotFound; // No English pivot translation found
            }

            // Step 2: English to Target Language
            const pivotQ2 = query(
                validatedSentencesRef,
                where("english", "==", pivotResult), // We assume the pivot result ("english") is already normalized in the DB
                limit(1)
            );
            const pivotSnap2 = await getDocs(pivotQ2);

            if (pivotSnap2.empty) {
                return outputNotFound;
            }
            const finalData = pivotSnap2.docs[0].data();
            return finalData[targetLangField] || outputNotFound;
        }

        function getLanguageField(langCode) {
            switch (langCode) {
                case 'NY': return 'nyanja';
                case 'BM': return 'bemba';
                case 'TO': return 'tonga';
                case 'LO': return 'lozi';
                case 'EN': return 'english';
                default: throw new Error(`Unknown language code: ${langCode}`);
            }
        }

        function swapLanguages() {
            const fromSelect = document.getElementById('from-lang');
            const toSelect = document.getElementById('to-lang');
            const fromVal = fromSelect.value;
            const toVal = toSelect.value;
            fromSelect.value = toVal;
            toSelect.value = fromVal;
        }

        // --- UI Helpers ---
        function setLoading(isLoading) {
            document.getElementById('translate-btn-text').style.display = isLoading ? 'none' : 'inline';
            document.getElementById('translate-icon').style.display = isLoading ? 'none' : 'inline';
            document.getElementById('loading-spinner').style.display = isLoading ? 'inline-block' : 'none';
            document.getElementById('translate-btn').disabled = isLoading;
        }

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('error-modal').classList.add('flex');
        }

        function hideModal() {
            document.getElementById('error-modal').classList.remove('flex');
        }

    </script>
</body>
</html>
