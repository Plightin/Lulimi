<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lulimi - Community Contribution Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn {
            @apply py-3 px-6 text-lg font-semibold text-gray-400 border-b-4 border-transparent hover:border-gray-600 hover:text-gray-200 transition-all;
        }
        .tab-btn.active {
            @apply text-white border-indigo-500;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.flex {
            display: flex;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center bg-gray-900 text-gray-200 p-4">

    <div class="w-full max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Lulimi CCP</h1>
            <p class="text-lg text-gray-400">Community Contribution Platform</p>
        </header>

        <!-- Validator Auth Controls -->
        <div class="text-center mb-6">
            <button id="validator-signin-btn" class="bg-gray-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600 transition duration-150">
                Validator Sign-In
            </button>
            <div id="user-info" class="text-gray-400 text-sm mt-2" style="display: none;">
                Signed in as <span id="user-email" class="font-medium text-indigo-400"></span>
                (<button id="signout-btn" class="text-indigo-400 hover:text-indigo-300 underline">Sign Out</button>)
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-700 flex justify-center">
            <button id="tab-contribute" class="tab-btn active" onclick="switchTab('contribute')">Contribute New Data</button>
            <button id="tab-validate" class="tab-btn" onclick="switchTab('validate')" style="display: none;">Validate Submissions</button>
        </div>

        <!-- Contribute Tab Content -->
        <div id="contribute-content" class="bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-10">
            <p class="text-center text-gray-300 mb-6">Help train the Lulimi engine by providing a high-quality translation. Your contribution is vital for preserving and digitizing our languages.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- English Input -->
                <div>
                    <label for="english-sentence" class="block text-sm font-medium text-gray-300 mb-2">English Sentence</label>
                    <textarea id="english-sentence" rows="5" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., The quick brown fox..."></textarea>
                </div>

                <!-- Zambian Language Input -->
                <div>
                    <label for="language-select" class="block text-sm font-medium text-gray-300 mb-2">Select Language</label>
                    <select id="language-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 mb-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="NY">Nyanja (Chichewa)</option>
                        <option value="BM">Bemba (Ichibemba)</option>
                        <option value="TO">Tonga (Chitonga)</option>
                        <option value="LO">Lozi (Silozi)</option>
                    </select>
                    <label for="zambian-translation" class="sr-only">Zambian Language Translation</label>
                    <textarea id="zambian-translation" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Genda bwinobwino..."></textarea>
                </div>
            </div>

            <!-- Submit Button -->
            <button id="submit-contribution-btn" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center">
                <svg id="submit-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg id="submit-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="submit-btn-text">Submit Contribution</span>
            </button>
        </div>

        <!-- Validate Tab Content -->
        <div id="validate-content" class="bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-10" style="display: none;">
            <p class="text-center text-gray-300 mb-6">Help us maintain quality by validating submissions. Approve correct translations, suggest corrections, or reject incorrect ones.</p>
            
            <div id="validation-card" class="bg-gray-900 border border-gray-700 rounded-lg p-6 min-h-[200px] flex flex-col justify-center">
                <!-- Loading State -->
                <div id="validation-loading" class="text-center text-gray-400">
                    <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading next submission...
                </div>
                
                <!-- Empty State -->
                <div id="validation-empty" class="text-center text-gray-400" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <h3 class="text-xl font-semibold text-white">All Clear!</h3>
                    <p>There are no submissions to validate right now. Thank you!</p>
                </div>

                <!-- Data State -->
                <div id="validation-data" style="display: none;">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400">English Sentence</label>
                        <p id="validation-english" class="text-lg text-white p-3 bg-gray-800 rounded-md"></p>
                    </div>
                    <div>
                        <label id="validation-lang-label" class="block text-sm font-medium text-gray-400">Zambian Language Translation</label>
                        <p id="validation-zambian" class="text-lg text-white p-3 bg-gray-800 rounded-md"></p>
                    </div>
                    
                    <!-- Correction Input (hidden by default) -->
                    <div id="correction-input-area" class="mt-4" style="display: none;">
                        <label for="correction-text" class="block text-sm font-medium text-gray-300">Your Correction:</label>
                        <textarea id="correction-text" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 mt-1 focus:ring-2 focus:ring-indigo-500"></textarea>
                        <button id="submit-correction-btn" class="w-full mt-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">
                            Submit Correction
                        </button>
                    </div>
                </div>
            </div>

            <!-- Validation Buttons -->
            <div id="validation-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6" style="display: none;">
                <button id="reject-btn" class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-150">
                    Reject
                </button>
                <button id="correct-btn" class="bg-yellow-500 text-gray-900 font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 transition duration-150">
                    Suggest Correction
                </button>
                <button id="approve-btn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-150">
                    Approve
                </button>
            </div>
        </div>

        <footer class="text-center mt-8 text-gray-500">
             <a href="https://lulimi-translator-457527257985.africa-south1.run.app/" id="contribute-btn" class="mb-6 inline-block bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition duration-150">
                Go to Lulimi Translator &rarr;
            </a>
            <p class="text-sm">&copy; 2025 Lulimi Language Engine by Inwit Systems Ltd.</p>
            <p class="text-xs mt-1">Building bridges, one word at a time.</p>
            <div class="flex flex-wrap justify-center gap-x-4 gap-y-2 mt-4 text-xs">
                <a href="https://onelink.to/inwitapp" class="hover:text-indigo-400" target="_blank">Download Inwit App</a>
                <a href="https://inwitsystems.com/radio/" class="hover:text-indigo-400" target="_blank">Inwit Online Radio</a>
                <a href="https://inwitsystems.com/" class="hover:text-indigo-400" target="_blank">More From Inwit Systems</a>
                <a href="https://inwit.tv/" class="hover:text-indigo-400" target="_blank">Stream Inwit TV</a>
            </div>
        </footer>
    </div>

    <!-- Modal -->
    <div id="error-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-semibold text-white mb-4">Error</h3>
            <p id="modal-message" class="text-gray-300 mb-6">An error occurred.</p>
            <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">
                Close
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            deleteDoc,
            query, 
            limit, 
            getDocs,
            serverTimestamp,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        let db, auth;
        let unvalidatedSentencesRef, usersRef;
        let currentValidationDoc = null;
        let currentUserId = null;
        let currentUserRole = "contributor";
        
        // This is your *live* configuration for the deployed app on Cloud Run
        const firebaseConfig = {
            apiKey: "AIzaSyBt_tv7FR5FxyDLpYxl8ZhyyZfqeB22e0Q",
            authDomain: "lulimi-ccp-project.firebaseapp.com",
            projectId: "lulimi-ccp-project",
            storageBucket: "lulimi-ccp-project.appspot.com",
        };
        
        // This is the config for the *secure Canvas environment*
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : null;
            
        const appId = (canvasFirebaseConfig && typeof __app_id !== 'undefined') 
            ? __app_id 
            : 'default-app-id';


        // --- UI Elements ---
        const validatorSigninBtn = document.getElementById('validator-signin-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const userInfoDiv = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const tabValidate = document.getElementById('tab-validate');
        const submitBtn = document.getElementById('submit-contribution-btn');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const isCanvas = !!canvasFirebaseConfig;
                let activeConfig = isCanvas ? canvasFirebaseConfig : firebaseConfig;

                if (!activeConfig || !activeConfig.projectId) {
                    throw new Error("Firebase config is missing or invalid.");
                }

                const app = initializeApp(activeConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Define collection paths
                unvalidatedSentencesRef = collection(db, `artifacts/${appId}/public/data/unvalidated_sentences`);
                usersRef = collection(db, `artifacts/${appId}/users`); // Private user roles

                // Listen for auth state changes
                onAuthStateChanged(auth, handleAuthStateChange);

                // --- Event Listeners ---
                submitBtn.addEventListener('click', submitContribution);
                validatorSigninBtn.addEventListener('click', signInWithGoogle);
                signoutBtn.addEventListener('click', logOut);
                
                document.getElementById('modal-close-btn').addEventListener('click', hideModal);
                
                // Validation button listeners
                document.getElementById('approve-btn').addEventListener('click', () => handleValidation('approve'));
                document.getElementById('reject-btn').addEventListener('click', () => handleValidation('reject'));
                document.getElementById('correct-btn').addEventListener('click', toggleCorrectionMode);
                document.getElementById('submit-correction-btn').addEventListener('click', submitCorrection);


            } catch (error) {
                console.error("Initialization failed:", error);
                showModal("Initialization Error", "Could not connect to the database.");
            }
        });

        // --- Authentication ---
        async function handleAuthStateChange(user) {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                
                if (user.isAnonymous) {
                    // ANONYMOUS USER (Contributor)
                    currentUserRole = "contributor (anonymous)";
                    updateUIAforUser(null, currentUserRole);
                    
                } else {
                    // GOOGLE USER (Potential Validator)
                    const userDocRef = doc(usersRef, user.uid);
                    let userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        // Create profile for new Google user
                        const newUser = {
                            email: user.email,
                            role: "contributor",
                            createdAt: serverTimestamp()
                        };
                        await setDoc(userDocRef, newUser);
                        userDoc = await getDoc(userDocRef); // Re-fetch doc
                    }
                    
                    currentUserRole = userDoc.data().role || "contributor";
                    updateUIAforUser(user, currentUserRole);
                }
                
                console.log(`User is authenticated: ${currentUserId}`);
                console.log(`User role: ${currentUserRole}`);

            } else {
                // User is signed out, sign them in anonymously
                console.log("User is signed out. Attempting anonymous sign-in...");
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    showModal("Auth Error", "Could not authenticate user.");
                }
            }
        }

        function updateUIAforUser(user, role) {
            if (user && !user.isAnonymous) {
                // Logged-in Google user
                userEmailSpan.textContent = user.email;
                userInfoDiv.style.display = 'block';
                validatorSigninBtn.style.display = 'none';
                
                if (role === 'validator') {
                    tabValidate.style.display = 'block';
                } else {
                    tabValidate.style.display = 'none';
                }
            } else {
                // Anonymous user
                userInfoDiv.style.display = 'none';
                validatorSigninBtn.style.display = 'block';
                tabValidate.style.display = 'none';
            }
            // Ensure contribute tab is active if validate is hidden
            if (tabValidate.style.display === 'none' && tabValidate.classList.contains('active')) {
                switchTab('contribute');
            }
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // Auth state change will be handled by onAuthStateChanged
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                showModal("Sign-In Error", "Could not sign in with Google. See console.");
            }
        }

        async function logOut() {
            try {
                await signOut(auth);
                // Auth state change will sign user in anonymously
            } catch (error) {
                console.error("Sign out failed:", error);
            }
        }

        // --- Contribution Logic ---
        async function submitContribution() {
            setLoading('submit', true);
            const englishSentence = document.getElementById('english-sentence').value.trim();
            const zambianTranslation = document.getElementById('zambian-translation').value.trim();
            const langCode = document.getElementById('language-select').value;
            const langField = getLanguageField(langCode);

            if (!englishSentence || !zambianTranslation) {
                showModal("Missing Information", "Please provide both an English sentence and a Zambian translation.");
                setLoading('submit', false);
                return;
            }

            // *** FIX: Normalize text to lowercase for case-insensitive search ***
            const normalizedEnglish = englishSentence.toLowerCase();
            const normalizedZambian = zambianTranslation.toLowerCase();

            try {
                const docData = {
                    english: normalizedEnglish,
                    [langField]: normalizedZambian,
                    lang: langCode,
                    approvals: 0,
                    submittedBy: currentUserId,
                    createdAt: serverTimestamp()
                };
                await addDoc(unvalidatedSentencesRef, docData);
                
                // Clear inputs
                document.getElementById('english-sentence').value = '';
                document.getElementById('zambian-translation').value = '';
                
                showModal("Success!", "Your contribution has been submitted for validation. Thank you!");

            } catch (error) {
                console.error("Error submitting contribution: ", error);
                showModal("Submission Error", "Could not submit your contribution. Please try again.");
            } finally {
                setLoading('submit', false);
            }
        }

        // --- Validation Logic ---
        async function loadNextValidationDoc() {
            setValidationState('loading');
            try {
                // Get one document that has not been validated by the current user
                // Firestore doesn't support "not-in" queries on arrays effectively for this
                // A more robust solution would be a Cloud Function, but for simplicity:
                // We fetch one document and check the subcollection.
                
                const q = query(unvalidatedSentencesRef, limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    setValidationState('empty');
                    return;
                }

                const docSnap = querySnapshot.docs[0];
                const docData = docSnap.data();
                const langField = getLanguageField(docData.lang);
                
                currentValidationDoc = {
                    id: docSnap.id,
                    data: docData,
                    langField: langField
                };

                // Display the data
                document.getElementById('validation-english').textContent = docData.english;
                document.getElementById('validation-zambian').textContent = docData[langField];
                document.getElementById('validation-lang-label').textContent = `${getLanguageName(docData.lang)} Translation`;
                
                setValidationState('data');

            } catch (error) {
                console.error("Error fetching validation doc: ", error);
                showModal("Error", "Could not fetch the next document for validation.");
                setValidationState('empty');
            }
        }

        async function handleValidation(action) {
            if (!currentValidationDoc) return;

            const docRef = doc(unvalidatedSentencesRef, currentValidationDoc.id);

            try {
                if (action === 'approve') {
                    // Increment approval count.
                    // A Cloud Function would be better to check for 3 approvals and move the doc.
                    // For now, we'll just increment. If it hits 3, we move it.
                    
                    const newApprovals = (currentValidationDoc.data.approvals || 0) + 1;

                    if (newApprovals >= 3) {
                        // Promote to validated collection
                        await promoteToValidated(currentValidationDoc.id, currentValidationDoc.data);
                        showModal("Submission Promoted!", "This submission has reached 3 approvals and has been validated.");
                    } else {
                        // Just update the count
                        await updateDoc(docRef, {
                            approvals: increment(1)
                        });
                    }

                } else if (action === 'reject') {
                    // Delete the unvalidated document
                    await deleteDoc(docRef);
                }
                
                // Load the next document
                loadNextValidationDoc();

            } catch (error) {
                console.error(`Error during ${action}: `, error);
                showModal("Error", `Could not ${action} the submission.`);
            }
        }

        async function toggleCorrectionMode() {
            const correctionArea = document.getElementById('correction-input-area');
            const validationText = document.getElementById('validation-zambian');
            
            if (correctionArea.style.display === 'none') {
                // Show correction box
                correctionArea.style.display = 'block';
                document.getElementById('correction-text').value = validationText.textContent;
                document.getElementById('correct-btn').textContent = "Cancel Correction";
                // Hide other buttons
                document.getElementById('approve-btn').style.display = 'none';
                document.getElementById('reject-btn').style.display = 'none';
            } else {
                // Hide correction box
                correctionArea.style.display = 'none';
                document.getElementById('correct-btn').textContent = "Suggest Correction";
                // Show other buttons
                document.getElementById('approve-btn').style.display = 'inline-block';
                document.getElementById('reject-btn').style.display = 'inline-block';
            }
        }
        
        async function submitCorrection() {
            if (!currentValidationDoc) return;
            
            const correctionText = document.getElementById('correction-text').value.trim();
            if (!correctionText) {
                showModal("Error", "Correction text cannot be empty.");
                return;
            }

            // *** FIX: Normalize text to lowercase for case-insensitive search ***
            const normalizedCorrection = correctionText.toLowerCase();

            try {
                // A correction from a validator is considered "gold standard"
                // We will create a new docData object with the correction
                const docData = {
                    ...currentValidationDoc.data,
                    [currentValidationDoc.langField]: normalizedCorrection,
                    // Ensure all other language fields are also lowercase
                    english: currentValidationDoc.data.english.toLowerCase(),
                    nyanja: (currentValidationDoc.data.nyanja || "").toLowerCase(),
                    bemba: (currentValidationDoc.data.bemba || "").toLowerCase(),
                    tonga: (currentValidationDoc.data.tonga || "").toLowerCase(),
                    lozi: (currentValidationDoc.data.lozi || "").toLowerCase(),
                    
                    validatedBy: currentUserId,
                    validatedAt: serverTimestamp()
                };

                // Promote this corrected data to the validated collection
                await promoteToValidated(currentValidationDoc.id, docData);

                showModal("Correction Submitted!", "Your correction has been approved and the submission is now validated.");
                
                // Reset correction mode
                toggleCorrectionMode();
                // Load next doc
                loadNextValidationDoc();

            } catch (error) {
                console.error("Error submitting correction: ", error);
                showModal("Error", "Could not submit your correction.");
            }
        }

        async function promoteToValidated(originalDocId, docData) {
            // 1. Create a new doc in 'validated_sentences'
            // We'll use the english text (normalized) as the ID to prevent duplicates
            // A hash might be better, but this is simpler
            
            // *** FIX: Ensure English text is normalized before using as ID ***
            const normalizedEnglish = docData.english.toLowerCase();
            
            const validatedDocRef = doc(db, `artifacts/${appId}/public/data/validated_sentences`, normalizedEnglish);
            
            // Clean up the data for validation
            delete docData.approvals;
            delete docData.submittedBy;
            docData.validatedAt = serverTimestamp();

            await setDoc(validatedDocRef, docData, { merge: true });

            // 2. Delete the original doc from 'unvalidated_sentences'
            const originalDocRef = doc(unvalidatedSentencesRef, originalDocId);
            await deleteDoc(originalDocRef);
        }

        // --- UI & Helper Functions ---
        function switchTab(tabName) {
            const contributeContent = document.getElementById('contribute-content');
            const validateContent = document.getElementById('validate-content');
            const tabContribute = document.getElementById('tab-contribute');
            const tabValidate = document.getElementById('tab-validate');

            if (tabName === 'contribute') {
                contributeContent.style.display = 'block';
                validateContent.style.display = 'none';
                tabContribute.classList.add('active');
                tabValidate.classList.remove('active');
            } else {
                contributeContent.style.display = 'none';
                validateContent.style.display = 'block';
                tabContribute.classList.remove('active');
                tabValidate.classList.add('active');
                // Load first doc for validation
                loadNextValidationDoc(); 
            }
        }
        
        function setValidationState(state) {
            document.getElementById('validation-loading').style.display = state === 'loading' ? 'block' : 'none';
            document.getElementById('validation-empty').style.display = state === 'empty' ? 'block' : 'none';
            document.getElementById('validation-data').style.display = state === 'data' ? 'block' : 'none';
            document.getElementById('validation-buttons').style.display = state === 'data' ? 'grid' : 'none';
            
            // Ensure correction mode is reset
            if (state !== 'data') {
                if (document.getElementById('correction-input-area').style.display === 'block') {
                    toggleCorrectionMode();
                }
            }
        }

        function setLoading(type, isLoading) {
            if (type === 'submit') {
                document.getElementById('submit-btn-text').style.display = isLoading ? 'none' : 'inline';
                document.getElementById('submit-icon').style.display = isLoading ? 'none' : 'inline';
                document.getElementById('submit-spinner').style.display = isLoading ? 'inline-block' : 'none';
                document.getElementById('submit-contribution-btn').disabled = isLoading;
            }
            // Add other loading types if needed
        }

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('error-modal').classList.add('flex');
        }

        function hideModal() {
            document.getElementById('error-modal').classList.remove('flex');
        }
        
        function getLanguageField(langCode) {
            switch (langCode) {
                case 'NY': return 'nyanja';
                case 'BM': return 'bemba';
                case 'TO': return 'tonga';
                case 'LO': return 'lozi';
                case 'EN': return 'english';
                default: throw new Error(`Unknown language code: ${langCode}`);
            }
        }
        
        function getLanguageName(langCode) {
            switch (langCode) {
                case 'NY': return 'Nyanja';
                case 'BM': return 'Bemba';
                case 'TO': return 'Tonga';
                case 'LO': return 'Lozi';
                case 'EN': return 'English';
                default: return 'Unknown';
            }
        }

    </script>
</body>
</html>
