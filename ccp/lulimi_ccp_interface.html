<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lulimi CCP - Contribute & Validate</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center py-6 bg-white shadow-md rounded-xl mb-8">
            <h1 class="text-4xl font-extrabold text-[#3B82F6] tracking-tight">LULIMI CCP</h1>
            <p class="text-xl text-gray-600 mt-1">Community Contribution Platform</p>
            <p id="user-status" class="text-sm mt-2 text-gray-500"></p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div role="tablist" class="flex border-b border-gray-200 mb-6">
                <button
                    class="tab-button flex-1 py-3 px-4 text-center font-medium transition-all duration-200"
                    data-tab="contribute"
                    onclick="switchTab('contribute')"
                >
                    Contribute Data
                </button>
                <button
                    class="tab-button flex-1 py-3 px-4 text-center font-medium transition-all duration-200"
                    data-tab="validate"
                    onclick="switchTab('validate')"
                >
                    Validate & Review
                </button>
            </div>

            <!-- TAB CONTENT -->

            <!-- 1. Contribute Tab -->
            <div id="contribute" class="tab-content space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Submit New Translation Pair</h2>
                
                <p class="text-sm text-gray-600 mb-4">Help us grow Lulimi! Enter a single English sentence and its perfect translation in one of the Zambian languages.</p>
                
                <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                    <div class="w-full md:w-1/3">
                        <label for="contribute-lang" class="block text-sm font-medium text-gray-700">Target Language</label>
                        <select id="contribute-lang" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#3B82F6] focus:ring-[#3B82F6] p-3 border">
                            <option value="NY">Nyanja (NY)</option>
                            <option value="BM">Bemba (BM)</option>
                            <option value="TO">Tonga (TO)</option>
                            <option value="LO">Lozi (LO)</option>
                        </select>
                    </div>
                    <div class="w-full md:w-2/3">
                        <label for="contribute-english" class="block text-sm font-medium text-gray-700">English Sentence</label>
                        <input type="text" id="contribute-english" placeholder="e.g., The sun is shining today." class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#3B82F6] focus:ring-[#3B82F6] p-3 border">
                    </div>
                </div>

                <div>
                    <label for="contribute-zambian" class="block text-sm font-medium text-gray-700">Zambian Translation</label>
                    <input type="text" id="contribute-zambian" placeholder="e.g., Dzuwa likuwala lero." class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#3B82F6] focus:ring-[#3B82F6] p-3 border">
                </div>
                
                <button onclick="submitContribution()" id="submit-contribution-btn" class="w-full py-3 px-4 bg-[#3B82F6] text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50">
                    Submit Contribution
                </button>
                <p id="contribution-message" class="text-center text-sm mt-2 hidden"></p>
            </div>

            <!-- 2. Validate Tab -->
            <div id="validate" class="tab-content hidden space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Review and Validate Data</h2>

                <div id="validation-card" class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <div id="no-data-message" class="text-center py-8 hidden">
                        <p class="text-lg text-gray-600">ðŸŽ‰ **Congratulations!** You've validated everything for now.</p>
                        <p class="text-sm text-gray-500 mt-2">Come back later, or switch to the **Contribute** tab!</p>
                    </div>

                    <div id="current-validation" class="space-y-4">
                        <p class="text-xs text-gray-500 font-medium tracking-wider uppercase mb-2">Sentence to Review (<span id="validation-lang-code">--</span>)</p>

                        <div class="bg-white p-4 rounded-lg border">
                            <label class="block text-sm font-medium text-gray-500">English (Source)</label>
                            <p id="val-english-text" class="text-lg font-medium text-gray-800 mt-1"></p>
                        </div>

                        <div id="zambian-translation-box" class="bg-white p-4 rounded-lg border relative">
                            <label class="block text-sm font-medium text-gray-500" id="val-zambian-label">Zambian Translation</label>
                            <p id="val-zambian-text" class="text-lg font-medium text-gray-800 mt-1"></p>
                            <textarea id="val-zambian-input" rows="3" class="hidden mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3 border text-lg" placeholder="Enter the corrected translation here."></textarea>
                        </div>

                        <p id="val-status-info" class="text-sm text-gray-600 mt-4">
                            Status: <span id="val-approval-count" class="font-bold text-blue-600">0</span> / 3 Approvals needed.
                        </p>

                        <div id="validation-actions" class="flex space-x-3 pt-2">
                            <button onclick="validateSentence(true)" id="btn-approve" class="flex-1 py-3 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out">
                                <span id="approve-text">Approve</span>
                            </button>
                            <button onclick="validateSentence(false)" id="btn-reject" class="py-3 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 ease-in-out">
                                Reject
                            </button>
                            <button onclick="toggleCorrectionMode()" id="btn-correct" class="py-3 px-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150 ease-in-out">
                                Suggest Correction
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <p id="error-message" class="text-center text-red-500 text-sm mt-4 hidden">An error occurred.</p>

        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables (MUST BE USED)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Set logging for debugging
        setLogLevel('Debug');

        // Firestore Path Helpers
        const UNVALIDATED_COLLECTION_PATH = `/artifacts/${appId}/public/data/unvalidated_sentences`;
        const VALIDATED_COLLECTION_PATH = `/artifacts/${appId}/public/data/validated_sentences`;

        // Local State
        let currentUserId = null;
        let currentReviewDoc = null; // Holds the Firestore document snapshot for the current review item
        let isCorrectionMode = false;
        const requiredApprovals = 3;

        // --- AUTHENTICATION & INITIALIZATION ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-status').textContent = `Logged in as: Contributor ${currentUserId.substring(0, 8)}...`;
            } else {
                currentUserId = crypto.randomUUID(); // Fallback for unauthenticated scenarios
                document.getElementById('user-status').textContent = `Logged in anonymously.`;
            }

            // After auth is ready, load the default tab (Contribute) and start loading validation data
            switchTab('contribute');
            if (document.getElementById('validate').classList.contains('active-tab')) {
                await fetchSentenceForValidation();
            }
        });

        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }

        // --- TAB SWITCHING LOGIC ---

        window.switchTab = (tabName) => {
            const tabs = ['contribute', 'validate'];
            tabs.forEach(tab => {
                const content = document.getElementById(tab);
                const button = document.querySelector(`.tab-button[data-tab="${tab}"]`);
                if (tab === tabName) {
                    content.classList.remove('hidden');
                    button.classList.add('active-tab', 'border-b-4', 'border-[#3B82F6]', 'text-[#3B82F6]');
                    button.classList.remove('text-gray-500');
                    if (tabName === 'validate') {
                        fetchSentenceForValidation();
                    }
                } else {
                    content.classList.add('hidden');
                    button.classList.remove('active-tab', 'border-b-4', 'border-[#3B82F6]', 'text-[#3B82F6]');
                    button.classList.add('text-gray-500');
                }
            });
        };

        // --- CONTRIBUTION LOGIC ---

        window.submitContribution = async () => {
            const englishText = document.getElementById('contribute-english').value.trim();
            const zambianText = document.getElementById('contribute-zambian').value.trim();
            const targetLang = document.getElementById('contribute-lang').value;
            const messageElement = document.getElementById('contribution-message');

            messageElement.classList.add('hidden');
            messageElement.classList.remove('text-green-500', 'text-red-500');

            if (!englishText || !zambianText) {
                messageElement.textContent = "Please fill in both the English and Zambian translation fields.";
                messageElement.classList.remove('hidden');
                messageElement.classList.add('text-red-500');
                return;
            }

            try {
                const newDocRef = collection(db, UNVALIDATED_COLLECTION_PATH);
                await addDoc(newDocRef, {
                    english: englishText,
                    zambian: zambianText,
                    language: targetLang,
                    status: 'pending',
                    approvals: 0,
                    rejections: 0,
                    approved_by: [],
                    rejected_by: [],
                    contributor_id: currentUserId,
                    created_at: serverTimestamp()
                });

                document.getElementById('contribute-english').value = '';
                document.getElementById('contribute-zambian').value = '';
                messageElement.textContent = "Thank you! Your contribution has been submitted for validation.";
                messageElement.classList.remove('hidden');
                messageElement.classList.add('text-green-500');

            } catch (e) {
                console.error("Error adding document: ", e);
                messageElement.textContent = "Submission failed. Please try again.";
                messageElement.classList.remove('hidden');
                messageElement.classList.add('text-red-500');
            }
        };

        // --- VALIDATION & CORRECTION LOGIC ---

        window.fetchSentenceForValidation = async () => {
            document.getElementById('current-validation').classList.add('hidden');
            document.getElementById('no-data-message').classList.add('hidden');
            currentReviewDoc = null;

            // Simple query to fetch one document that the current user hasn't approved or rejected
            try {
                const q = query(
                    collection(db, UNVALIDATED_COLLECTION_PATH),
                    where('approved_by', 'not-array-contains', currentUserId),
                    where('rejected_by', 'not-array-contains', currentUserId),
                    limit(1)
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    document.getElementById('no-data-message').classList.remove('hidden');
                    return;
                }

                currentReviewDoc = snapshot.docs[0];
                const data = currentReviewDoc.data();

                // Reset correction mode
                setCorrectionMode(false);

                // Populate UI
                document.getElementById('val-english-text').textContent = data.english;
                document.getElementById('val-zambian-text').textContent = data.zambian;
                document.getElementById('val-zambian-input').value = data.zambian; // Initialize correction box
                document.getElementById('validation-lang-code').textContent = data.language;
                document.getElementById('val-approval-count').textContent = data.approvals || 0;
                document.getElementById('current-validation').classList.remove('hidden');

            } catch (e) {
                console.error("Error fetching sentence:", e);
                document.getElementById('error-message').textContent = `Failed to load review data: ${e.message}`;
                document.getElementById('error-message').classList.remove('hidden');
            }
        };

        window.validateSentence = async (isApproved) => {
            if (!currentReviewDoc) return;

            const docRef = currentReviewDoc.ref;
            const docId = currentReviewDoc.id;

            try {
                await runTransaction(db, async (transaction) => {
                    const freshDoc = await transaction.get(docRef);
                    if (!freshDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const data = freshDoc.data();
                    let updatedData = { ...data };

                    if (isApproved) {
                        // Approval Logic
                        if (!data.approved_by.includes(currentUserId)) {
                            updatedData.approvals = (data.approvals || 0) + 1;
                            updatedData.approved_by = [...data.approved_by, currentUserId];
                        }
                    } else {
                        // Rejection Logic
                        if (!data.rejected_by.includes(currentUserId)) {
                            updatedData.rejections = (data.rejections || 0) + 1;
                            updatedData.rejected_by = [...data.rejected_by, currentUserId];
                        }
                    }

                    // Check for promotion to Gold Standard
                    if (updatedData.approvals >= requiredApprovals) {
                        // Promote to validated collection and delete from unvalidated
                        const validatedDocRef = doc(db, VALIDATED_COLLECTION_PATH, docId);
                        transaction.set(validatedDocRef, {
                            english: updatedData.english,
                            zambian: updatedData.zambian,
                            language: updatedData.language,
                            contributor_id: updatedData.contributor_id,
                            validated_by: updatedData.approved_by,
                            finalized_at: serverTimestamp()
                        });
                        transaction.delete(docRef);
                        console.log(`Sentence ${docId} promoted to Gold Standard.`);
                    } else {
                        // Update the current unvalidated document
                        transaction.update(docRef, updatedData);
                    }
                });

                await fetchSentenceForValidation(); // Load the next sentence

            } catch (e) {
                console.error("Validation Transaction failed:", e);
                document.getElementById('error-message').textContent = `Validation failed: ${e.message}`;
                document.getElementById('error-message').classList.remove('hidden');
            }
        };

        window.toggleCorrectionMode = () => {
            isCorrectionMode = !isCorrectionMode;
            setCorrectionMode(isCorrectionMode);

            if (isCorrectionMode) {
                // Change Approve button to Finalize Correction
                document.getElementById('approve-text').textContent = 'Finalize Correction';
                document.getElementById('btn-reject').disabled = true;
                document.getElementById('btn-correct').textContent = 'Cancel Correction';
            } else {
                // Revert to standard Validation mode
                document.getElementById('approve-text').textContent = 'Approve';
                document.getElementById('btn-reject').disabled = false;
                document.getElementById('btn-correct').textContent = 'Suggest Correction';
            }
        };

        const setCorrectionMode = (enabled) => {
            const zambianTextElement = document.getElementById('val-zambian-text');
            const zambianInputElement = document.getElementById('val-zambian-input');

            if (enabled) {
                zambianTextElement.classList.add('hidden');
                zambianInputElement.classList.remove('hidden');
                document.getElementById('val-zambian-label').textContent = 'Zambian Translation (Edit)';
            } else {
                zambianTextElement.classList.remove('hidden');
                zambianInputElement.classList.add('hidden');
                document.getElementById('val-zambian-label').textContent = 'Zambian Translation';
            }
            isCorrectionMode = enabled;
        };


        window.finalizeCorrection = async () => {
            if (!currentReviewDoc || !isCorrectionMode) return;

            const docRef = currentReviewDoc.ref;
            const docId = currentReviewDoc.id;
            const correctedZambian = document.getElementById('val-zambian-input').value.trim();

            if (!correctedZambian) {
                alert("Correction cannot be empty.");
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const freshDoc = await transaction.get(docRef);
                    if (!freshDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const data = freshDoc.data();

                    // 1. Promote to validated collection immediately
                    const validatedDocRef = doc(db, VALIDATED_COLLECTION_PATH, docId);
                    transaction.set(validatedDocRef, {
                        english: data.english,
                        zambian: correctedZambian, // Use the corrected text
                        language: data.language,
                        contributor_id: data.contributor_id,
                        validated_by: [currentUserId], // Finalized by the corrector
                        corrected: true,
                        finalized_at: serverTimestamp()
                    });

                    // 2. Delete from unvalidated queue
                    transaction.delete(docRef);
                    console.log(`Sentence ${docId} finalized by correction and promoted.`);
                });

                await fetchSentenceForValidation(); // Load the next sentence

            } catch (e) {
                console.error("Correction Finalization failed:", e);
                document.getElementById('error-message').textContent = `Finalization failed: ${e.message}`;
                document.getElementById('error-message').classList.remove('hidden');
            }
        };

        // --- Event Listeners and Setup ---
        
        // This helper function toggles between standard validation and correction logic
        document.getElementById('btn-approve').addEventListener('click', () => {
            if (isCorrectionMode) {
                finalizeCorrection();
            } else {
                validateSentence(true);
            }
        });

        // Start the auth process
        initializeAuth();
    </script>
</body>
</html>
