<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lulimi - Community Contribution Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn {
            @apply py-3 px-6 text-lg font-semibold text-gray-400 border-b-4 border-transparent hover:border-gray-600 hover:text-gray-200 transition-all cursor-pointer;
        }
        .tab-btn.active {
            @apply text-white border-indigo-500;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.flex {
            display: flex;
        }
        /* Audio recorder button pulsing */
        .record-btn-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: .75;
                transform: scale(1.05);
            }
        }
    </style>
</head>
<body class="h-full flex items-center justify-center bg-gray-900 text-gray-200 p-4">

    <div class="w-full max-w-4xl">
        <header class="text-center mb-8">
            <!-- SVG Logo REPLACED with Image Logo -->
            <img src="https://storage.googleapis.com/lulimi-ccp-project.firebasestorage.app/lulimi_logo.png" alt="Lulimi Logo" class="h-20 w-auto mx-auto mb-4"
                 onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block'">
            <!-- Fallback text if logo fails to load -->
            <h1 id="logo-fallback" class="text-4xl font-bold text-white mb-2" style="display: none;">Lulimi CCP</h1>

            <h1 class="text-4xl font-bold text-white mb-2">Lulimi CCP</h1>
            <p class="text-lg text-gray-400">Community Contribution Platform</p>
        </header>

        <!-- Validator Auth Controls -->
        <div class="text-center mb-6">
            <button id="validator-signin-btn" class="bg-gray-700 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600 transition duration-150">
                Validator Sign-In
            </button>
            <div id="user-info" class="text-gray-400 text-sm mt-2" style="display: none;">
                Signed in as <span id="user-email" class="font-medium text-indigo-400"></span>
                (<button id="signout-btn" class="text-indigo-400 hover:text-indigo-300 underline">Sign Out</button>)
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-700 flex justify-center">
            <button id="tab-contribute" class="tab-btn active">Contribute New Data</button>
            <button id="tab-validate" class="tab-btn" style="display: none;">Validate Submissions</button>
        </div>

        <!-- Contribute Tab Content -->
        <div id="contribute-content" class="bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-10">
            <p class="text-center text-gray-300 mb-6">Help train the Lulimi engine by providing a high-quality translation. Your contribution is vital for preserving and digitizing our languages.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- English Input -->
                <div>
                    <label for="english-sentence" class="block text-sm font-medium text-gray-300 mb-2">English Sentence</label>
                    <textarea id="english-sentence" rows="5" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., The quick brown fox..."></textarea>
                </div>

                <!-- Zambian Language Input -->
                <div>
                    <label for="language-select" class="block text-sm font-medium text-gray-300 mb-2">Select Language</label>
                    <select id="language-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 mb-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="NY">Nyanja (Chichewa)</option>
                        <option value="BM">Bemba (Ichibemba)</option>
                        <option value="TO">Tonga (Chitonga)</option>
                        <option value="LO">Lozi (Silozi)</option>
                    </select>
                    <label for="zambian-translation" class="sr-only">Zambian Language Translation</label>
                    <textarea id="zambian-translation" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Genda bwinobwino..."></textarea>
                </div>
            </div>

            <!-- Submit Button -->
            <button id="submit-contribution-btn" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center">
                <svg id="submit-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg id="submit-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="submit-btn-text">Submit Contribution</span>
            </button>
        </div>

        <!-- Validate Tab Content -->
        <div id="validate-content" class="bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-10" style="display: none;">
            
            <!-- Step 1: Validation Card -->
            <div id="validation-step">
                <p class="text-center text-gray-300 mb-6">Help us maintain quality by validating submissions. Approve correct translations, suggest corrections, or reject incorrect ones.</p>
                
                <div id="validation-card" class="bg-gray-900 border border-gray-700 rounded-lg p-6 min-h-[200px] flex flex-col justify-center">
                    <!-- Loading State -->
                    <div id="validation-loading" class="text-center text-gray-400">
                        <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading next submission...
                    </div>
                    
                    <!-- Empty State -->
                    <div id="validation-empty" class="text-center text-gray-400" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <h3 class="text-xl font-semibold text-white">All Clear!</h3>
                        <p>There are no submissions to validate right now. Thank you!</p>
                    </div>

                    <!-- Data State -->
                    <div id="validation-data" style="display: none;">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-400">English Sentence</label>
                            <p id="validation-english" class="text-lg text-white p-3 bg-gray-800 rounded-md"></p>
                        </div>
                        <div>
                            <label id="validation-lang-label" class="block text-sm font-medium text-gray-400">Zambian Language Translation</label>
                            <p id="validation-zambian" class="text-lg text-white p-3 bg-gray-800 rounded-md"></p>
                        </div>
                        
                        <!-- Correction Input (hidden by default) -->
                        <div id="correction-input-area" class="mt-4" style="display: none;">
                            <label for="correction-text" class="block text-sm font-medium text-gray-300">Your Correction:</label>
                            <textarea id="correction-text" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 mt-1 focus:ring-2 focus:ring-indigo-500"></textarea>
                            <button id="submit-correction-btn" class="w-full mt-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">
                                Submit Correction
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Validation Buttons -->
                <div id="validation-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6" style="display: none;">
                    <button id="reject-btn" class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-150">
                        Reject
                    </button>
                    <button id="correct-btn" class="bg-yellow-500 text-gray-900 font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 transition duration-150">
                        Suggest Correction
                    </button>
                    <button id="approve-btn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-150">
                        Approve
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Audio Recorder (New) -->
            <div id="audio-recorder-area" class="text-center" style="display: none;">
                <h3 class="text-xl font-semibold text-white mb-2">Pronunciation successfully validated!</h3>
                <p class="text-gray-300 mb-6">Please record a high-quality audio clip for this translation:</p>
                <p id="audio-text-to-record" class="text-2xl font-bold text-indigo-300 mb-6 p-4 bg-gray-900 rounded-lg"></p>
                
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                    <!-- Audio Player -->
                    <audio id="audio-playback" controls class="w-full mb-4" style="display: none;"></audio>

                    <!-- Record/Stop Buttons -->
                    <button id="record-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-150 flex items-center justify-center text-lg record-btn-pulse">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2" /></svg>
                        Start Recording
                    </button>
                    <button id="stop-btn" class="w-full bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-150" style="display: none;">
                        Stop Recording
                    </button>
                </div>

                <!-- Finalize Buttons -->
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button id="skip-audio-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-150">
                        Skip Audio & Continue
                    </button>
                    <button id="save-audio-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150" disabled>
                        Save & Continue
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-gray-500">
             <a href="https://lulimi-translator-457527257985.africa-south1.run.app/" id="contribute-btn" class="mb-6 inline-block bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition duration-150">
                Go to Lulimi Translator &rarr;
            </a>
            <p class="text-sm">&copy; 2025 Lulimi Language Engine by Inwit Systems Ltd.</p>
            <p class="text-xs mt-1">Building bridges, one word at a time.</p>
            <div class="flex flex-wrap justify-center gap-x-4 gap-y-2 mt-4 text-xs">
                <a href="https://onelink.to/inwitapp" class="hover:text-indigo-400" target="_blank">Download Inwit App</a>
                <a href="https://inwitsystems.com/radio/" class="hover:text-indigo-400" target="_blank">Inwit Online Radio</a>
                <a href="https://inwitsystems.com/" class="hover:text-indigo-400" target="_blank">More From Inwit Systems</a>
                <a href="https://inw.tv/" class="hover:text-indigo-400" target="_blank">Stream Inwit TV</a>
            </div>
        </footer>
    </div>

    <!-- Modal -->
    <div id="error-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-semibold text-white mb-4">Error</h3>
            <p id="modal-message" class="text-gray-300 mb-6">An error occurred.</p>
            <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150">
                Close
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            deleteDoc,
            query, 
            limit, 
            getDocs,
            serverTimestamp,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- NEW: Import Firebase Storage ---
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Configuration ---
        let db, auth, storage; // <-- NEW: Added storage
        let unvalidatedSentencesRef, usersRef;
        let currentValidationDoc = null;
        let currentUserId = null;
        let currentUserRole = "contributor";
        let isCanvas = false;
        let appId = 'default-app-id';
        
        // --- NEW: Audio Recorder variables ---
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let validatedDocDataToPromote = null; // Temp holder for doc data

        const firebaseConfig = {
            apiKey: "AIzaSyBt_tv7FR5FxyDLpYxl8ZhyyZfqeB22e0Q",
            authDomain: "lulimi-ccp-project.firebaseapp.com",
            projectId: "lulimi-ccp-project",
            storageBucket: "lulimi-ccp-project.appspot.com", // <-- Storage bucket must be defined
        };
        
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : null;
            
        if (canvasFirebaseConfig && typeof __app_id !== 'undefined') {
            isCanvas = true;
            appId = __app_id;
        }

        // --- UI Elements ---
        const validatorSigninBtn = document.getElementById('validator-signin-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const userInfoDiv = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const tabContributeBtn = document.getElementById('tab-contribute');
        const tabValidateBtn = document.getElementById('tab-validate');
        const submitBtn = document.getElementById('submit-contribution-btn');

        // --- NEW: Audio UI Elements ---
        const validationStepDiv = document.getElementById('validation-step');
        const audioRecorderArea = document.getElementById('audio-recorder-area');
        const audioTextToRecord = document.getElementById('audio-text-to-record');
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const audioPlayback = document.getElementById('audio-playback');
        const saveAudioBtn = document.getElementById('save-audio-btn');
        const skipAudioBtn = document.getElementById('skip-audio-btn');


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                let activeConfig;

                if (isCanvas) {
                    console.log("Initializing with secure Canvas config.");
                    activeConfig = canvasFirebaseConfig;
                } else {
                    console.log("Initializing with public production config.");
                    activeConfig = firebaseConfig;
                }

                if (!activeConfig || !activeConfig.projectId) {
                    const id = isCanvas ? (appId || "App ID") : (activeConfig.projectId || "Project ID");
                    throw new Error(`${id} is missing. The app cannot start.`);
                }
                
                // --- NEW: Check for storageBucket ---
                if (!activeConfig.storageBucket) {
                    throw new Error("storageBucket is missing from Firebase config. Cannot initialize audio features.");
                }
                
                const app = initializeApp(activeConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app); // <-- NEW: Initialize Storage

                unvalidatedSentencesRef = collection(db, `artifacts/${appId}/public/data/unvalidated_sentences`);
                usersRef = collection(db, `artifacts/${appId}/users`); 

                onAuthStateChanged(auth, handleAuthStateChange);

                // --- Event Listeners (FIXED) ---
                // Removed inline onclick attributes and added proper listeners
                submitBtn.addEventListener('click', submitContribution);
                validatorSigninBtn.addEventListener('click', signInWithGoogle);
                signoutBtn.addEventListener('click', logOut);
                
                tabContributeBtn.addEventListener('click', () => switchTab('contribute'));
                tabValidateBtn.addEventListener('click', () => switchTab('validate'));
                
                document.getElementById('modal-close-btn').addEventListener('click', hideModal);
                
                document.getElementById('approve-btn').addEventListener('click', () => handleValidation('approve'));
                document.getElementById('reject-btn').addEventListener('click', () => handleValidation('reject'));
                document.getElementById('correct-btn').addEventListener('click', toggleCorrectionMode);
                document.getElementById('submit-correction-btn').addEventListener('click', submitCorrection);

                // --- NEW: Audio Event Listeners ---
                recordBtn.addEventListener('click', startRecording);
                stopBtn.addEventListener('click', stopRecording);
                saveAudioBtn.addEventListener('click', saveAudioAndProceed);
                skipAudioBtn.addEventListener('click', skipAudioAndProceed);

            } catch (error) {
                console.error("Initialization failed:", error);
                showModal("Configuration Error", error.message);
            }
        });

        // --- Authentication (No Changes) ---
        async function handleAuthStateChange(user) {
            if (user) {
                currentUserId = user.uid;
                if (user.isAnonymous) {
                    currentUserRole = "contributor (anonymous)";
                    updateUIAforUser(null, currentUserRole);
                } else {
                    const userDocRef = doc(usersRef, user.uid);
                    let userDoc = await getDoc(userDocRef);
                    if (!userDoc.exists()) {
                        const newUser = {
                            email: user.email || "Canvas User",
                            role: "contributor",
                            createdAt: serverTimestamp()
                        };
                        await setDoc(userDocRef, newUser);
                        userDoc = await getDoc(userDocRef);
                    }
                    currentUserRole = userDoc.data().role || "contributor";
                    updateUIAforUser(user, currentUserRole);
                }
                console.log(`User is authenticated: ${currentUserId}`);
                console.log(`User role: ${currentUserRole}`);
            } else {
                if (isCanvas && typeof __initial_auth_token !== 'undefined') {
                    console.log("Canvas environment detected. Signing in with custom token...");
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                         console.error("Canvas custom token sign-in failed:", error);
                         showModal("Auth Error", "Could not authenticate user in Canvas. " + error.message);
                    }
                } else if (!isCanvas) {
                    console.log("Live environment. Attempting anonymous sign-in...");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        showModal("Auth Error", "Could not authenticate user. " + error.message);
                    }
                } else {
                    console.error("Auth failed: In Canvas but no auth token found.");
                    showModal("Auth Error", "Cannot authenticate user. No auth token provided.");
                }
            }
        }

        function updateUIAforUser(user, role) {
            if (user && !user.isAnonymous) {
                userEmailSpan.textContent = user.email || "Canvas User";
                userInfoDiv.style.display = 'block';
                validatorSigninBtn.style.display = 'none';
                if (role === 'validator') {
                    tabValidateBtn.style.display = 'block';
                } else {
                    tabValidateBtn.style.display = 'none';
                }
            } else {
                userInfoDiv.style.display = 'none';
                validatorSigninBtn.style.display = 'block';
                tabValidateBtn.style.display = 'none';
            }
            if (tabValidateBtn.style.display === 'none' && tabValidateBtn.classList.contains('active')) {
                switchTab('contribute');
            }
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                showModal("Sign-In Error", "Could not sign in with Google. See console.");
            }
        }

        async function logOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out failed:", error);
            }
        }

        // --- Contribution Logic (No Changes) ---
        async function submitContribution() {
            setLoading('submit', true);
            const englishSentence = document.getElementById('english-sentence').value.trim();
            const zambianTranslation = document.getElementById('zambian-translation').value.trim();
            const langCode = document.getElementById('language-select').value;
            const langField = getLanguageField(langCode);

            if (!englishSentence || !zambianTranslation) {
                showModal("Missing Information", "Please provide both an English sentence and a Zambian translation.");
                setLoading('submit', false);
                return;
            }

            const normalizedEnglish = englishSentence.toLowerCase();
            const normalizedZambian = zambianTranslation.toLowerCase();

            try {
                const docData = {
                    english: normalizedEnglish,
                    [langField]: normalizedZambian,
                    lang: langCode,
                    approvals: 0,
                    submittedBy: currentUserId,
                    createdAt: serverTimestamp()
                };
                await addDoc(unvalidatedSentencesRef, docData);
                
                document.getElementById('english-sentence').value = '';
                document.getElementById('zambian-translation').value = '';
                
                showModal("Success!", "Your contribution has been submitted for validation. Thank you!");

            } catch (error) {
                console.error("Error submitting contribution: ", error);
                showModal("Submission Error", "Could not submit your contribution. Please try again. Check console for details.");
            } finally {
                setLoading('submit', false);
            }
        }

        // --- Validation Logic (UPDATED) ---
        async function loadNextValidationDoc() {
            // --- NEW: Ensure recorder is hidden ---
            validationStepDiv.style.display = 'block';
            audioRecorderArea.style.display = 'none';
            
            setValidationState('loading');
            try {
                const q = query(unvalidatedSentencesRef, limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    setValidationState('empty');
                    return;
                }

                const docSnap = querySnapshot.docs[0];
                const docData = docSnap.data();
                
                if (!docData.lang) {
                    console.warn("Skipping document with missing 'lang' field:", docSnap.id);
                    await deleteDoc(doc(unvalidatedSentencesRef, docSnap.id));
                    loadNextValidationDoc();
                    return;
                }
                
                const langField = getLanguageField(docData.lang);
                
                if (!docData[langField]) {
                    console.warn(`Skipping document with missing '${langField}' data:`, docSnap.id);
                    await deleteDoc(doc(unvalidatedSentencesRef, docSnap.id));
                    loadNextValidationDoc();
                    return;
                }
                
                currentValidationDoc = {
                    id: docSnap.id,
                    data: docData,
                    langField: langField
                };

                document.getElementById('validation-english').textContent = docData.english;
                document.getElementById('validation-zambian').textContent = docData[langField];
                document.getElementById('validation-lang-label').textContent = `${getLanguageName(docData.lang)} Translation`;
                
                setValidationState('data');

            } catch (error) {
                console.error("Error fetching validation doc: ", error);
                showModal("Error", "Could not fetch the next document for validation.");
                setValidationState('empty');
            }
        }

        async function handleValidation(action) {
            if (!currentValidationDoc) return;
            const docRef = doc(unvalidatedSentencesRef, currentValidationDoc.id);

            try {
                if (action === 'approve') {
                    const newApprovals = (currentValidationDoc.data.approvals || 0) + 1;
                    if (newApprovals >= 3) {
                        // --- NEW: Trigger audio recording step ---
                        const approvedData = { ...currentValidationDoc.data };
                        // Ensure all text is lowercase before moving to audio step
                        approvedData.english = (approvedData.english || "").toLowerCase();
                        approvedData[currentValidationDoc.langField] = (approvedData[currentValidationDoc.langField] || "").toLowerCase();
                        
                        promptForAudio(approvedData);
                    } else {
                        // Just update the count and load next doc
                        await updateDoc(docRef, { approvals: increment(1) });
                        loadNextValidationDoc();
                    }
                } else if (action === 'reject') {
                    // Delete the unvalidated document and load next
                    await deleteDoc(docRef);
                    loadNextValidationDoc();
                }
            } catch (error) {
                console.error(`Error during ${action}: `, error);
                showModal("Error", `Could not ${action} the submission.`);
            }
        }
        
        async function submitCorrection() {
            if (!currentValidationDoc) return;
            const correctionText = document.getElementById('correction-text').value.trim();
            if (!correctionText) {
                showModal("Error", "Correction text cannot be empty.");
                return;
            }
            const normalizedCorrection = correctionText.toLowerCase();

            try {
                // A correction from a validator is "gold standard"
                const correctedData = {
                    ...currentValidationDoc.data,
                    [currentValidationDoc.langField]: normalizedCorrection,
                    english: (currentValidationDoc.data.english || "").toLowerCase(),
                    validatedBy: currentUserId,
                    validatedAt: serverTimestamp()
                };

                // --- NEW: Trigger audio recording step ---
                promptForAudio(correctedData);
                toggleCorrectionMode(); // Hide correction box

            } catch (error) {
                console.error("Error submitting correction: ", error);
                showModal("Error", "Could not submit your correction.");
            }
        }
        
        // --- NEW: Audio Recording Flow ---
        
        function promptForAudio(validatedData) {
            // Store the data that will be promoted
            validatedDocDataToPromote = validatedData; 
            
            // Show the text to be recorded
            const textToRecord = validatedData[currentValidationDoc.langField];
            audioTextToRecord.textContent = `"${textToRecord}"`;
            
            // Reset audio state
            audioBlob = null;
            audioChunks = [];
            audioPlayback.style.display = 'none';
            audioPlayback.src = '';
            saveAudioBtn.disabled = true;
            recordBtn.style.display = 'block';
            recordBtn.classList.add('record-btn-pulse');
            stopBtn.style.display = 'none';
            
            // Switch views
            validationStepDiv.style.display = 'none';
            audioRecorderArea.style.display = 'block';
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/mp3' }); // Using mp3, though webm or ogg might be more standard
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    audioPlayback.style.display = 'block';
                    saveAudioBtn.disabled = false;
                    audioChunks = []; // Clear chunks for next recording
                };
                
                mediaRecorder.start();
                
                // Update UI
                recordBtn.style.display = 'none';
                recordBtn.classList.remove('record-btn-pulse');
                stopBtn.style.display = 'block';
                
            } catch (error) {
                console.error("Error accessing microphone:", error);
                showModal("Microphone Error", "Could not access your microphone. Please grant permission in your browser.");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                // Update UI
                recordBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }
        }

        async function saveAudioAndProceed() {
            if (!audioBlob || !validatedDocDataToPromote) return;
            
            setLoading('audioSave', true); // Implement this
            
            const englishText = validatedDocDataToPromote.english;
            const langCode = validatedDocDataToPromote.lang;
            
            // Create a unique file path
            const audioPath = `pronunciations/${langCode}/${englishText}.mp3`;
            const storageRef = ref(storage, audioPath);
            
            try {
                // 1. Upload the audio blob
                await uploadBytes(storageRef, audioBlob);
                
                // 2. Get the download URL
                const downloadURL = await getDownloadURL(storageRef);
                
                // 3. Add the URL to our doc data
                validatedDocDataToPromote.pronunciationURL = downloadURL;
                
                // 4. Promote the document to validated_sentences
                await promoteToValidated(currentValidationDoc.id, validatedDocDataToPromote);
                
                showModal("Success!", "Translation and audio have been saved.");
                loadNextValidationDoc(); // Load the next doc
                
            } catch (error) {
                console.error("Audio upload failed:", error);
                showModal("Upload Error", "Could not save the audio file. Please try again.");
            } finally {
                setLoading('audioSave', false); // Implement this
            }
        }
        
        async function skipAudioAndProceed() {
            // Promote the document *without* the audio URL
            if (!validatedDocDataToPromote) return;
            
            try {
                await promoteToValidated(currentValidationDoc.id, validatedDocDataToPromote);
                showModal("Success!", "Translation has been saved (audio skipped).");
                loadNextValidationDoc();
            } catch (error) {
                console.error("Error promoting doc:", error);
                showModal("Error", "Could not save the submission.");
            }
        }

        // ---
        
        async function promoteToValidated(originalDocId, docData) {
            const normalizedEnglish = (docData.english || "unknown").toLowerCase();
            if (!normalizedEnglish || normalizedEnglish === "unknown") {
                 console.error("Cannot promote document with empty English text.");
                 await deleteDoc(doc(unvalidatedSentencesRef, originalDocId));
                 return;
            }
            
            const validatedDocRef = doc(db, `artifacts/${appId}/public/data/validated_sentences`, normalizedEnglish);
            
            // Clean up the data
            delete docData.approvals;
            delete docData.submittedBy;
            // Ensure all lang fields are present and lowercase, even if empty
            docData.english = (docData.english || "").toLowerCase();
            docData.nyanja = (docData.nyanja || "").toLowerCase();
            docData.bemba = (docData.bemba || "").toLowerCase();
            docData.tonga = (docData.tonga || "").toLowerCase();
            docData.lozi = (docData.lozi || "").toLowerCase();

            await setDoc(validatedDocRef, docData, { merge: true });

            const originalDocRef = doc(unvalidatedSentencesRef, originalDocId);
            await deleteDoc(originalDocRef);
        }

        // --- UI & Helper Functions ---

        /**
         * Toggles the visibility of the correction input box.
         */
        function toggleCorrectionMode() {
            const correctionArea = document.getElementById('correction-input-area');
            const correctionText = document.getElementById('correction-text');
            const correctBtn = document.getElementById('correct-btn');

            if (correctionArea.style.display === 'none') {
                // Show correction box
                correctionArea.style.display = 'block';
                correctionText.value = document.getElementById('validation-zambian').textContent;
                correctionText.focus();
                correctBtn.textContent = "Cancel Correction";
                correctBtn.classList.remove('bg-yellow-500', 'text-gray-900', 'hover:bg-yellow-600');
                correctBtn.classList.add('bg-gray-600', 'text-white', 'hover:bg-gray-700');
            } else {
                // Hide correction box
                correctionArea.style.display = 'none';
                correctionText.value = '';
                correctBtn.textContent = "Suggest Correction";
                correctBtn.classList.add('bg-yellow-500', 'text-gray-900', 'hover:bg-yellow-600');
                correctBtn.classList.remove('bg-gray-600', 'text-white', 'hover:bg-gray-700');
            }
        }

        function switchTab(tabName) {
            const contributeContent = document.getElementById('contribute-content');
            const validateContent = document.getElementById('validate-content');
            const tabContribute = document.getElementById('tab-contribute');
            const tabValidate = document.getElementById('tab-validate');

            if (tabName === 'contribute') {
                contributeContent.style.display = 'block';
                validateContent.style.display = 'none';
                tabContribute.classList.add('active');
                tabValidate.classList.remove('active');
            } else {
                contributeContent.style.display = 'none';
                validateContent.style.display = 'block';
                tabContribute.classList.remove('active');
                tabValidate.classList.add('active');
                loadNextValidationDoc(); 
            }
        }
        
        function setValidationState(state) {
            document.getElementById('validation-loading').style.display = state === 'loading' ? 'block' : 'none';
            document.getElementById('validation-empty').style.display = state === 'empty' ? 'block' : 'none';
            document.getElementById('validation-data').style.display = state === 'data' ? 'block' : 'none';
            document.getElementById('validation-buttons').style.display = state === 'data' ? 'grid' : 'none';
            
            if (state !== 'data') {
                if (document.getElementById('correction-input-area').style.display === 'block') {
                    toggleCorrectionMode();
                }
            }
        }

        function setLoading(type, isLoading) {
            if (type === 'submit') {
                document.getElementById('submit-btn-text').style.display = isLoading ? 'none' : 'inline';
                document.getElementById('submit-icon').style.display = isLoading ? 'none' : 'inline';
                document.getElementById('submit-spinner').style.display = isLoading ? 'inline-block' : 'none';
                document.getElementById('submit-contribution-btn').disabled = isLoading;
            } else if (type === 'audioSave') {
                // Create a simple loading state for the audio buttons
                saveAudioBtn.disabled = isLoading;
                skipAudioBtn.disabled = isLoading;
                saveAudioBtn.textContent = isLoading ? "Saving..." : "Save & Continue";
            }
        }

        function showModal(title, message) {
            console.log(`Modal Shown: ${title} - ${message}`);
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message || "An error occurred. Please check the console.";
            document.getElementById('error-modal').classList.add('flex');
        }

        function hideModal() {
            document.getElementById('error-modal').classList.remove('flex');
        }
        
        function getLanguageField(langCode) {
            switch (langCode) {
                case 'NY': return 'nyanja';
                case 'BM': return 'bemba';
                case 'TO': return 'tonga';
                case 'LO': return 'lozi';
                case 'EN': return 'english';
                default: throw new Error(`Unknown language code: ${langCode}`);
            }
        }
        
        function getLanguageName(langCode) {
            switch (langCode) {
                case 'NY': return 'Nyanja';
                case 'BM': return 'Bemba';
                case 'TO': return 'Tonga';
                case 'LO': return 'Lozi';
                case 'EN': return 'English';
                default: return 'Unknown';
            }
        }

    </script>
</body>
</html>
