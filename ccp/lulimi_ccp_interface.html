<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lulimi - Community Contribution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for loading spinner */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-full font-sans antialiased text-gray-200">
    <div id="app" class="flex flex-col items-center justify-center min-h-screen bg-gray-900 p-4">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-2">Lulimi</h1>
            <p class="text-xl text-indigo-300">Community Contribution Platform</p>
        </div>

        <!-- Main Content Area -->
        <div class="w-full max-w-3xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
            
            <!-- Tab Navigation -->
            <div class="flex bg-gray-700">
                <button id="tab-contribute" onclick="switchTab('contribute')" class="flex-1 py-4 px-6 font-semibold text-lg text-white border-b-4 border-indigo-500 hover:bg-gray-600 transition duration-200">
                    Contribute New Data
                </button>
                <button id="tab-validate" onclick="switchTab('validate')" class="flex-1 py-4 px-6 font-semibold text-lg text-gray-400 border-b-4 border-transparent hover:bg-gray-600 transition duration-200">
                    Validate Submissions
                </button>
            </div>

            <!-- Panels -->
            <div class="p-8">
                <!-- Contribution Panel -->
                <div id="panel-contribute">
                    <p class="text-gray-300 mb-6 text-lg">
                        Help train the Lulimi engine by providing a high-quality translation. Your contribution is vital for preserving and digitizing our languages.
                    </p>
                    <form id="contribution-form">
                        <div class="mb-6">
                            <label for="language-select" class="block text-sm font-medium text-gray-300 mb-2">Select Language</label>
                            <select id="language-select" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="NY">Nyanja (Chichewa)</option>
                                <option value="BM">Bemba (ChiBemba)</option>
                                <option value="TO">Tonga (ChiTonga)</option>
                                <option value="LO">Lozi (SiLozi)</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label for="english-text" class="block text-sm font-medium text-gray-300 mb-2">English Sentence</label>
                            <textarea id="english-text" rows="3" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., The quick brown fox jumps over the lazy dog."></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="zambian-text" class="block text-sm font-medium text-gray-300 mb-2">Zambian Language Translation</label>
                            <textarea id="zambian-text" rows="3" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Genda bwinobwino..."></textarea>
                        </div>
                        <button type="button" onclick="submitContribution()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 shadow-lg">
                            Submit Contribution
                        </button>
                    </form>
                </div>

                <!-- Validation Panel -->
                <div id="panel-validate" class="hidden">
                    <p class="text-gray-300 mb-6 text-lg">
                        Review submissions from other users. You need 3 approvals to add a sentence to the training data.
                    </p>
                    <div id="validation-card" class="bg-gray-700 p-6 rounded-lg shadow-inner">
                        <div id="validation-loader" class="flex justify-center items-center h-48">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-500 h-12 w-12"></div>
                        </div>
                        <div id="validation-content" class="hidden">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-400 mb-1">English</label>
                                <p id="validate-english" class="text-lg text-white p-3 bg-gray-800 rounded-md"></p>
                            </div>
                            <div class="mb-6">
                                <label id="validate-language-label" class="block text-sm font-medium text-gray-400 mb-1">Suggested Translation (Nyanja)</label>
                                <p id="validate-zambian" class="text-lg text-white p-3 bg-gray-800 rounded-md"></p>
                                <!-- Editable text area for corrections -->
                                <textarea id="validate-zambian-edit" class="hidden w-full text-lg text-white p-3 bg-gray-900 rounded-md border border-indigo-500" rows="3"></textarea>
                            </div>
                            
                            <!-- Standard Validation Buttons -->
                            <div id="standard-buttons" class="flex space-x-4">
                                <button onclick="handleValidation('reject')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                                    Reject
                                </button>
                                <button onclick="suggestCorrection()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg transition duration-200">
                                    Suggest Correction
                                </button>
                                <button onclick="handleValidation('approve')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                                    Approve
                                </button>
                            </div>
                            <!-- Correction Mode Buttons -->
                            <div id="correction-buttons" class="hidden flex space-x-4">
                                <button onclick="cancelCorrection()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                                    Cancel
                                </button>
                                <button onclick="submitCorrection()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                                    Submit Final Correction
                                </button>
                            </div>
                        </div>
                        <div id="validation-empty" class="hidden text-center h-48 flex flex-col justify-center items-center">
                            <p class="text-xl text-gray-400">No submissions to validate!</p>
                            <p class="text-gray-500">Please check back later or add a new contribution.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <p class="mt-8 text-gray-500">Lulimi Language Engine &copy; 2025. Building bridges, one word at a time.</p>
    </div>

    <!-- Modal for feedback -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full p-8 text-center">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-4">Thank You!</h3>
            <p id="modal-message" class="text-gray-300 text-lg mb-6">Your contribution has been submitted for validation.</p>
            <button onclick="closeModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                Close
            </button>
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, setLogLevel, doc, getDoc, addDoc, setDoc, updateDoc, 
            deleteDoc, onSnapshot, collection, query, where, getDocs, 
            runTransaction, writeBatch, limit, increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- !! CONFIGURATION FIX !! ---
        // This hardcoded config is used ONLY when the app is running on the live URL.
        // When running in the Canvas, the secure __firebase_config will be used instead.
        // You MUST restrict your API key in the Google Cloud Console to your live URL.
        const firebaseConfig = {
            apiKey: "AIzaSyBt_tv7FR5FxyDLpYxl8ZhyyZfqeB22e0Q", // <-- Updated Key
            authDomain: "lulimi-ccp-project.firebaseapp.com",
            projectId: "lulimi-ccp-project",
            storageBucket: "lulimi-ccp-project.appspot.com",
        };
        
        // --- End of Config ---

        // Initialize Firebase
        let app, db, auth, userId, appId; // <-- Added appId here
        let currentValidationDocId = null;
        let currentValidationDocData = null;

        // --- App Initialization ---
        
        async function initializeLulimiApp() {
            try {
                // Check for secure Canvas environment first
                const isCanvasEnv = typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined';
                
                const config = isCanvasEnv 
                    ? JSON.parse(__firebase_config) 
                    : firebaseConfig;
                
                // Use default-app-id if not in Canvas, as appId is only for public pathing
                appId = isCanvasEnv 
                    ? __app_id 
                    : 'default-app-id'; // Fallback for live deploy

                // *** Check for essential config keys ***
                if (!config.projectId) {
                    console.error("FirebaseError: 'projectId' not provided in firebase.initializeApp.");
                    showModal("Configuration Error", "Firebase ProjectID is missing. The app cannot start.");
                    return; // Stop execution if config is broken
                }
                
                if (!config.apiKey) {
                    console.error("FirebaseError: 'apiKey' not provided in firebase.initializeApp.");
                    showModal("Configuration Error", "Firebase API Key is missing. The app cannot start.");
                    return; // Stop execution if config is broken
                }

                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable detailed Firestore logging

                // Authenticate the user
                await authUser(isCanvasEnv);
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showModal("Initialization Error", "Could not connect to Firebase. Please check the console.");
            }
        }

        async function authUser(isCanvasEnv) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User is authenticated:", user.uid);
                    userId = user.uid;
                    // User is signed in, load validation data
                    loadNextValidation();
                } else {
                    console.log("No user signed in, authenticating...");
                    try {
                        // Use custom token if in Canvas, otherwise fallback to anonymous
                        if (isCanvasEnv && typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // This is the fallback for the live deployed app
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        // This is where the "Auth Error" modal comes from.
                        // Check if Anonymous Sign-in is enabled in your Firebase project.
                        showModal("Auth Error", "Could not authenticate user. Check Firebase Console settings.");
                    }
                }
            });
        }

        // --- UI Control ---

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modal').classList.add('hidden');
        }

        window.switchTab = function(tab) {
            if (tab === 'contribute') {
                document.getElementById('panel-contribute').classList.remove('hidden');
                document.getElementById('panel-validate').classList.add('hidden');
                document.getElementById('tab-contribute').classList.add('text-white', 'border-indigo-500');
                document.getElementById('tab-contribute').classList.remove('text-gray-400', 'border-transparent');
                document.getElementById('tab-validate').classList.add('text-gray-400', 'border-transparent');
                document.getElementById('tab-validate').classList.remove('text-white', 'border-indigo-500');
            } else {
                document.getElementById('panel-contribute').classList.add('hidden');
                document.getElementById('panel-validate').classList.remove('hidden');
                document.getElementById('tab-contribute').classList.remove('text-white', 'border-indigo-500');
                document.getElementById('tab-contribute').classList.add('text-gray-400', 'border-transparent');
                document.getElementById('tab-validate').classList.remove('text-gray-400', 'border-transparent');
                document.getElementById('tab-validate').classList.add('text-white', 'border-indigo-500');
                // Refresh validation card when switching
                if (!currentValidationDocId) {
                    loadNextValidation();
                }
            }
        }

        // --- Contribution Logic ---

        window.submitContribution = async function() {
            if (!db || !appId) {
                showModal("Error", "Database not connected.");
                return;
            }

            const lang = document.getElementById('language-select').value;
            const english = document.getElementById('english-text').value.trim();
            const zambian = document.getElementById('zambian-text').value.trim();

            if (!english || !zambian) {
                showModal("Error", "Please fill in both sentences.");
                return;
            }

            try {
                // Use the public collection path
                const colRef = collection(db, "artifacts", appId, "public", "data", "unvalidated_sentences");
                const docRef = await addDoc(colRef, {
                    lang: lang,
                    english: english,
                    zambian: zambian,
                    approvals: 0,
                    rejections: 0,
                    submittedBy: userId,
                    submittedAt: new Date()
                });
                console.log("Document written with ID: ", docRef.id);
                showModal("Thank You!", "Your contribution has been submitted for validation.");
                // Clear the form
                document.getElementById('contribution-form').reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal("Submission Error", "Could not submit your contribution. See console for details.");
            }
        }

        // --- Validation Logic ---

        async function loadNextValidation() {
            if (!db || !userId || !appId) {
                console.warn("DB, User, or AppID not ready for validation load.");
                return;
            }

            document.getElementById('validation-loader').classList.remove('hidden');
            document.getElementById('validation-content').classList.add('hidden');
            document.getElementById('validation-empty').classList.add('hidden');
            cancelCorrection(); // Reset correction state

            try {
                // Use the public collection path
                const colRef = collection(db, "artifacts", appId, "public", "data", "unvalidated_sentences");
                
                // Query for a document that the user has NOT submitted
                const q = query(
                    colRef,
                    where("submittedBy", "!=", userId),
                    limit(1)
                );

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No documents to validate.");
                    document.getElementById('validation-empty').classList.remove('hidden');
                    currentValidationDocId = null;
                    currentValidationDocData = null;
                } else {
                    const doc = querySnapshot.docs[0];
                    currentValidationDocId = doc.id;
                    currentValidationDocData = doc.data();

                    // Display the data
                    document.getElementById('validate-english').innerText = currentValidationDocData.english;
                    document.getElementById('validate-zambian').innerText = currentValidationDocData.zambian;
                    document.getElementById('validate-language-label').innerText = `Suggested Translation (${currentValidationDocData.lang})`;
                    
                    document.getElementById('validation-content').classList.remove('hidden');
                    // *** SYNTAX ERROR FIX: Removed the stray text block from here ***
                    document.getElementById('validation-loader').classList.add('hidden');
                }
            } catch (e) {
                console.error("Error fetching validation doc: ", e);
                showModal("Validation Error", "Could not load a document to validate. Check permissions.");
            } finally {
                document.getElementById('validation-loader').classList.add('hidden');
            }
        }

        window.handleValidation = async function(action) {
            if (!currentValidationDocId || !db || !appId) return;

            // Use the public collection path
            const docRef = doc(db, "artifacts", appId, "public", "data", "unvalidated_sentences", currentValidationDocId);

            try {
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(docRef);
                    if (!sfDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const data = sfDoc.data();
                    let newApprovals = data.approvals;
                    let newRejections = data.rejections;

                    if (action === 'approve') {
                        newApprovals = (newApprovals || 0) + 1;
                    } else if (action === 'reject') {
                        newRejections = (newRejections || 0) + 1;
                    }

                    // Check for promotion (3 approvals)
                    if (newApprovals >= 3) {
                        // Promote to validated_sentences (public path)
                        const validatedRef = doc(collection(db, "artifacts", appId, "public", "data", "validated_sentences"));
                        transaction.set(validatedRef, {
                            lang: data.lang,
                            english: data.english,
                            zambian: data.zambian,
                            validatedAt: new Date(),
                            validatedBy: "community_approval"
                        });
                        // Delete from unvalidated
                        transaction.delete(docRef);
                        console.log("Promoted document to validated:", currentValidationDocId);
                    } 
                    // Check for demotion (3 rejections)
                    else if (newRejections >= 3) {
                        // Delete from unvalidated
                        transaction.delete(docRef);
                        console.log("Rejected and deleted document:", currentValidationDocId);
                    } 
                    // Otherwise, just update the counters
                    else {
                        transaction.update(docRef, { 
                            approvals: newApprovals,
                            rejections: newRejections
                        });
                    }
                });

                console.log(`Transaction successfully committed for action: ${action}`);
                showModal("Success", `Submission has been ${action}d.`);
            } catch (e) {
                console.error("Transaction failed: ", e);
                showModal("Error", "Validation action failed. See console.");
            }

            // Load the next document
            loadNextValidation();
        }
        
        // --- Correction Logic ---

        window.suggestCorrection = function() {
            if (!currentValidationDocData) return;
            
            // Show edit area, hide text
            document.getElementById('validate-zambian').classList.add('hidden');
            const editArea = document.getElementById('validate-zambian-edit');
            editArea.value = currentValidationDocData.zambian; // Pre-fill with current text
            editArea.classList.remove('hidden');
            
            // Swap button visibility
            document.getElementById('standard-buttons').classList.add('hidden');
            document.getElementById('correction-buttons').classList.remove('hidden');
        }

        window.cancelCorrection = function() {
            // Hide edit area, show text
            document.getElementById('validate-zambian').classList.remove('hidden');
            document.getElementById('validate-zambian-edit').classList.add('hidden');
            
            // Swap button visibility
            document.getElementById('standard-buttons').classList.remove('hidden');
            document.getElementById('correction-buttons').classList.add('hidden');
        }

        window.submitCorrection = async function() {
            if (!currentValidationDocId || !currentValidationDocData || !db || !appId) return;

            const correctedText = document.getElementById('validate-zambian-edit').value.trim();
            if (!correctedText || correctedText === currentValidationDocData.zambian) {
                showModal("Error", "Please make a change or cancel.");
                return;
            }

            // A correction is considered a final, "gold standard" approval.
            // We will move it directly to the validated collection.
            
            const batch = writeBatch(db);
            
            // 1. Add to validated_sentences (public path)
            const validatedRef = doc(collection(db, "artifacts", appId, "public", "data", "validated_sentences"));
            batch.set(validatedRef, {
                lang: currentValidationDocData.lang,
                english: currentValidationDocData.english,
                zambian: correctedText, // Use the new corrected text
                validatedAt: new Date(),
                validatedBy: userId // Mark who made the correction
            });
            
            // 2. Delete from unvalidated_sentences (public path)
            const unvalidatedRef = doc(db, "artifacts", appId, "public", "data", "unvalidated_sentences", currentValidationDocId);
            batch.delete(unvalidatedRef);

            try {
                await batch.commit();
                showModal("Success", "Your correction has been submitted and finalized.");
                console.log("Correction submitted and finalized:", currentValidationDocId);
                loadNextValidation(); // Load next doc
            } catch (e) {
                console.error("Error submitting correction: ", e);
                showModal("Error", "Could not submit correction. See console.");
            }
        }


        // --- Global Init ---
        // Expose functions to global scope to be accessible by onclick attributes
        // This is necessary because we are in a module
        window.submitContribution = submitContribution;
        window.switchTab = switchTab;
        window.handleValidation = handleValidation;
        window.suggestCorrection = suggestCorrection;
        window.cancelCorrection = cancelCorrection;
        window.submitCorrection = submitCorrection;
        
        // Start the application
        initializeLulimiApp();

    </script>
</body>
</html>
